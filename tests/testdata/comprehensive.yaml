---
version: "2.0"
services:
  web:
    image: nginx:1.25.3
    command:
      - "nginx"
      - "-g"
      - "daemon off;"
    args:
      - "--prefix=/usr/share/nginx"
    env:
      - "NGINX_HOST=example.com"
      - "NGINX_PORT=80"
    expose:
      - port: 80
        as: 80
        accept:
          - web.example.com
          - www.example.com
        to:
          - global: true
        http_options:
          max_body_size: 5242880
          read_timeout: 30000
          send_timeout: 30000
          next_tries: 5
          next_timeout: 5000
          next_cases:
            - error
            - timeout
            - "502"
            - "503"
      - port: 443
        as: 443
        to:
          - global: true
      - port: 8080
        to:
          - service: api
  api:
    image: node:20-alpine
    command:
      - "node"
    args:
      - "server.js"
      - "--port=3000"
    env:
      - "NODE_ENV=production"
      - "DATABASE_URL=postgres://user:pass@db:5432/mydb"
      - "REDIS_URL=redis://cache:6379"
      - "LOG_LEVEL=info"
    expose:
      - port: 3000
        as: 3000
        to:
          - global: true
      - port: 9090
        proto: udp
        to:
          - global: true
  db:
    image: postgres:16
    env:
      - "POSTGRES_DB=mydb"
      - "POSTGRES_USER=user"
      - "POSTGRES_PASSWORD=pass"
    expose:
      - port: 5432
        to:
          - service: api
  cache:
    image: redis:7.2
    expose:
      - port: 6379
        to:
          - service: api
profiles:
  compute:
    web:
      resources:
        cpu:
          units: "500m"
        memory:
          size: "512Mi"
        storage:
          size: "2Gi"
    api:
      resources:
        cpu:
          units: 2
        memory:
          size: "2Gi"
        storage:
          - name: default
            size: "5Gi"
          - name: uploads
            size: "10Gi"
    db:
      resources:
        cpu:
          units: "1000m"
        memory:
          size: "4Gi"
        storage:
          size: "20Gi"
    cache:
      resources:
        cpu:
          units: "250m"
        memory:
          size: "1Gi"
        storage:
          size: "512Mi"
  placement:
    dcloud:
      attributes:
        region: us-west
        tier: premium
      signedBy:
        anyOf:
          - 1
          - 2
        allOf:
          - 3
      pricing:
        web:
          denom: uakt
          amount: 500
        api:
          denom: uakt
          amount: 1000
        db:
          denom: uakt
          amount: 800
        cache:
          denom: uakt
          amount: 300
deployment:
  web:
    dcloud:
      profile: web
      count: 2
  api:
    dcloud:
      profile: api
      count: 3
  db:
    dcloud:
      profile: db
      count: 1
  cache:
    dcloud:
      profile: cache
      count: 1
