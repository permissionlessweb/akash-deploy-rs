# Provider Validation Tool - justfile
#
# Verifies Rust client JWT + manifest output against
# actual Go provider code (AuthProcess, Manifest.Version).
#
# Usage:
#   just test          - run all SDL test cases + JWT verification
#   just test-sdl      - run only manifest hash tests against all SDLs
#   just test-jwt-only - run only JWT verification

# Show available commands
default:
    @just --list

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# Full integration test - one command to verify everything
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

# Run full provider compatibility test: build â†’ generate â†’ verify (all SDLs + JWT)
# Note: Go binary (provider-validate) is pre-built and checked in
test: build-rust build-go test-jwt-only test-sdl
    @echo ""
    @echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    @echo "  âœ… ALL INTEGRATION TESTS PASSED"
    @echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# Build steps
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

# Build the Rust test binary (JWT + manifest generator)
build-rust:
    @echo "ğŸ¦€ Building Rust client..."
    cd examples/rust-jwt-gen && cargo build

# Build the Go provider validator (requires akash provider source)
# The pre-built binary is already included, so this is optional
build-go:
    @echo "ğŸ“¦ Building Go provider validator..."
    @go build -o provider-validate .

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# JWT verification
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

# Verify JWT signing against provider AuthProcess()
test-jwt-only:
    #!/usr/bin/env bash
    set -e
    echo ""
    echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo "  JWT VERIFICATION"
    echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    # Generate JWT (use any SDL, just need key material)
    SDL_PATH="$(cd testdata && pwd)/simple.yaml"
    FIXTURES_DIR="$(pwd)/fixtures/jwt-test"
    cd examples/rust-jwt-gen
    OUTPUT=$(cargo run --quiet -- "$SDL_PATH" "$FIXTURES_DIR")
    cd ../..
    JWT=$(cat "$FIXTURES_DIR/jwt.txt")
    PUBKEY=$(cat "$FIXTURES_DIR/pubkey.txt")
    echo "  ğŸ” Verifying Rust JWT with provider AuthProcess()..."
    ./provider-validate jwt "$JWT" "$PUBKEY"
    rm -rf "$FIXTURES_DIR"

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# Manifest hash verification - cycles through all SDL test cases
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

# Run manifest hash tests against every SDL in testdata/
test-sdl:
    #!/usr/bin/env bash
    set -e
    echo ""
    echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo "  MANIFEST HASH VERIFICATION"
    echo "  Testing all SDLs in testdata/"
    echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    PASS=0
    FAIL=0
    FAILED_FILES=""
    for sdl in testdata/*.yaml; do
        NAME=$(basename "$sdl" .yaml)
        echo ""
        echo "  â”€â”€ $NAME â”€â”€"
        SDL_PATH="$(cd "$(dirname "$sdl")" && pwd)/$(basename "$sdl")"
        FIXTURES_DIR="$(pwd)/fixtures/$NAME"
        # Generate manifest + hash with Rust engine
        cd examples/rust-jwt-gen
        if ! cargo run --quiet -- "$SDL_PATH" "$FIXTURES_DIR"; then
            echo "  âŒ Rust generation failed for $NAME"
            FAIL=$((FAIL + 1))
            FAILED_FILES="$FAILED_FILES $NAME"
            cd ../..
            continue
        fi
        cd ../..
        # Verify with Go provider logic
        HASH=$(cat "$FIXTURES_DIR/manifest-hash.txt" | tr -d '[:space:]')
        if ./provider-validate manifest "$FIXTURES_DIR/manifest.json" "$HASH"; then
            PASS=$((PASS + 1))
        else
            FAIL=$((FAIL + 1))
            FAILED_FILES="$FAILED_FILES $NAME"
        fi
    done
    echo ""
    echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo "  Results: $PASS passed, $FAIL failed"
    if [ $FAIL -gt 0 ]; then
        echo "  Failed:$FAILED_FILES"
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        exit 1
    fi
    echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# Standalone commands
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

# Test a single SDL file
test-one SDL: build-rust
    #!/usr/bin/env bash
    set -e
    SDL_PATH="$(cd "$(dirname "{{SDL}}")" && pwd)/$(basename "{{SDL}}")"
    FIXTURES_DIR="$(pwd)/fixtures/single-test"
    cd examples/rust-jwt-gen
    cargo run --quiet -- "$SDL_PATH" "$FIXTURES_DIR"
    cd ../..
    HASH=$(cat "$FIXTURES_DIR/manifest-hash.txt" | tr -d '[:space:]')
    ./provider-validate manifest "$FIXTURES_DIR/manifest.json" "$HASH"

# Clean build artifacts and fixtures
clean:
    rm -f provider-validate jwt-verify
    rm -rf fixtures/
    cd examples/rust-jwt-gen && cargo clean

# Quick check of Go code
check:
    go vet ./...
    go fmt ./...
